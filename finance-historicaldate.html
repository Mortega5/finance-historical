<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--
An element providing a solution to no problem in particular.

Example:

<finance-historicaldate></finance-historicaldate>

Example:

<finance-historicaldate>
<h2>Hello finance-historicaldate</h2>
</finance-historicaldate>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="finance-historicaldate">
  <template>
  <style>
  :host {
    visibility: hidden;
  }
  </style>
</template>

<script>
Polymer({
  is: 'finance-historicaldate',

  properties: {
    _query: {
      type: String,
      computed:'_generateQuery(symbol,start,end)'
    },
    symbol: {
      type: String,
      notify: true
    },
    end: {
      type: Date,
      value: function(){return new Date()},
      notify:true
    },
    start: {
      type: Date,
      notify: true
    },
    data: {
      type: Array,
      value: function(){return []},
      notify: true
    }
  },
  ready: function(){
    this.addEventListener('start-changed', this.requestData.bind(this));
    this.addEventListener('end-changed', this.requestData.bind(this));
    this.addEventListener('symbol-changed', this.requestData.bind(this));
    this.requestData();
  },
  _generateQuery: function(symbol,start,end){
    var query_start = new Date(start);
    var query_end = new Date(end);
    var q_start = {
      year:query_start.getFullYear(),
      month:query_start.getMonth()+1 < 9? '0'+(query_start.getMonth()+1):(query_start.getMonth()+1),
      day:query_start.getDate() < 9? '0'+query_start.getDate():query_start.getDate()
    };
    var q_end = {
      year:query_end.getFullYear(),
      month:query_end.getMonth()+1 < 9? '0'+(query_end.getMonth()+1):(query_end.getMonth()+1),
      day:query_end.getDate() < 9? '0'+query_end.getDate():query_end.getDate()
    };
    query_start = q_start.year + '-' + q_start.month + '-' + q_start.day;
    query_end = q_end.year + '-' + q_end.month + '-' + q_end.day;
    // ADD symbol
    query ='select * from yahoo.finance.historicaldata where symbol = "' + symbol + '"';
    // ADD start
    query += ' and startDate = "' + query_start + '"';
    // ADD end
    query += ' and endDate = "' + query_end + '"';
    return query

  },
  _yqlQuery: function(query,callback){
    if (!query || !callback){
      console.error('Query and callback is required');
      this.fire('finance-historicaldate-error',{error:'Query and callback is required'});
    } else {
      var script = document.createElement('script');
      var encodedQuery = encodeURIComponent(query);
      window.yahoo_callback_wrapper = function(json){
        document.body.removeChild(script);
        window.yahoo_callback_wrapper = undefined;
        callback(json);
      }.bind(this)
      script.src = 'https://query.yahooapis.com/v1/public/yql?q=' + encodedQuery+'&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=yahoo_callback_wrapper'
      document.body.appendChild(script)
    }
  },
  requestData: function(){
    if (this.symbol && this.start && this.end){
      this.fire('finance-historicaldate-inicated');
      this._yqlQuery(this._query, this._financeApiResponse.bind(this));
    }
  },
  _financeApiResponse: function(data){
    if (data.error){
      this.requestData();
      return null;
    } else if (!data.query.results){
      this.fire('finance-historicaldate-error',{error:{description:'Invalid start,end or symbol'}});
      return null;
    }
    this.set('data', data.query.results.quote);
    this.fire('finance-historicaldate-ready',{data:this.data});
  }
});
</script>
</dom-module>
